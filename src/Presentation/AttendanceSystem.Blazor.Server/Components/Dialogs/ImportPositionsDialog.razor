@using AttendanceSystem.Application.Features.Positions.Commands.CreatePosition
@using AttendanceSystem.Application.Abstractions
@using AttendanceSystem.Application.DTOs.Import
@using MediatR
@using Microsoft.AspNetCore.Components.Forms
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject IImportService ImportService

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.body1" Class="mb-4">
            Suba un archivo Excel (.xlsx) con los datos de los puestos.
            <br />
            <b>Columnas requeridas:</b> Nombre, Descripción, Salario Base.
        </MudText>

        <MudFileUpload T="IBrowserFile" FilesChanged="UploadFiles" Accept=".xlsx">
            <ActivatorContent>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload">
                    Seleccionar Archivo
                </MudButton>
            </ActivatorContent>
        </MudFileUpload>

        @if (_processing)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
            <MudText Class="mt-2">Procesando archivo... @(_progressText)</MudText>
        }
        
        @if (_summary.Any())
        {
             <MudAlert Severity="Severity.Info" Class="mt-2">Resultados de la importación:</MudAlert>
             <MudList T="string" Dense="true" ReadOnly="true">
                 @foreach(var item in _summary)
                 {
                     <MudListItem Text="@item" />
                 }
             </MudList>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cerrar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    private bool _processing = false;
    private string _progressText = "";
    private List<string> _summary = new();

    private void Cancel() => MudDialog.Cancel();

    private async Task UploadFiles(IBrowserFile file)
    {
        if (file == null) return;

        _processing = true;
        _summary.Clear();
        _progressText = "Leyendo archivo...";
        await InvokeAsync(StateHasChanged);

        long maxFileSize = 1024 * 1024 * 10; 

        try
        {
            using var stream = new MemoryStream();
            await file.OpenReadStream(maxFileSize).CopyToAsync(stream);
            stream.Position = 0;

            if (file.Name.EndsWith(".xlsx", StringComparison.OrdinalIgnoreCase))
            {
                await ProcessExcel(stream);
            }
            else
            {
                Snackbar.Add("Formato no soportado. Use .xlsx", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al subir: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ProcessExcel(Stream stream)
    {
        int successCount = 0;
        int errorCount = 0;
        var errorMessages = new List<string>();

        // 1. Parse via Service
        var result = await ImportService.ParsePositionsAsync(stream);
        
        if (result.Errors.Any())
        {
             foreach (var err in result.Errors) _summary.Add(err);
             if (result.ValidEntries.Count == 0) return;
        }

        // 2. Map to Commands
        var commands = result.ValidEntries.Select(dto => new CreatePositionCommand(dto.Name, dto.Description, dto.BaseSalary)).ToList();

        _progressText = $"Importando {commands.Count} registros...";
        await InvokeAsync(StateHasChanged);

        foreach (var command in commands)
        {
             try 
             {
                 var cmdResult = await Mediator.Send(command);
                 if (cmdResult.IsSuccess)
                     successCount++;
                 else
                 {
                     errorCount++;
                     if(errorMessages.Count < 5) errorMessages.Add($"Error: {cmdResult.Error}");
                 }
             }
             catch(Exception ex)
             {
                 errorCount++;
                 if(errorMessages.Count < 5) errorMessages.Add($"Excepción: {ex.Message}");
             }
        }

        _summary.Add($"Importación completada.");
        _summary.Add($"Exitosos: {successCount}");
        _summary.Add($"Fallidos: {errorCount}");
        foreach (var err in errorMessages) _summary.Add(err);

        if (errorCount > 0 && errorMessages.Count >= 5) _summary.Add("...");
        
        if (successCount > 0)
        {
             Snackbar.Add($"Se importaron {successCount} puestos.", Severity.Success);
             MudDialog.Close(DialogResult.Ok(true));
        }
        else if (errorCount > 0)
        {
             Snackbar.Add("Hubo errores en la importación.", Severity.Warning);
        }
        else
        {
             Snackbar.Add("No se encontraron registros válidos para importar.", Severity.Info);
        }
    }
}
