@page "/attendance/cards"
@using MediatR
@using AttendanceSystem.Application.Features.Reports.Queries.GetAttendanceReport
@using AttendanceSystem.Application.Features.Employees.Queries
@using AttendanceSystem.Application.Features.Employees
@using AttendanceSystem.Application.Features.Branches.Queries.GetBranches
@using AttendanceSystem.Application.DTOs
@using AttendanceSystem.Domain.ValueObjects
@using AttendanceSystem.Application.Common
@using AttendanceSystem.Domain.Enumerations
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject IReportExportService ReportService

<style>
    @@media print {
        .no-print { display: none !important; }
        .page-break { page-break-after: always; }
        .print-container {
            width: 100%;
            background-color: white;
            color: black;
            font-family: Arial, sans-serif;
        }
        body { background-color: white; color: black; }
        .mud-layout { display: block; }
        .mud-main-content { padding: 0; margin: 0; }
        .mud-appbar { display: none; }
        .mud-drawer { display: none; }
        
        /* Ensure table borders print correctly */
        .card-table, .card-table th, .card-table td {
            border: 1px solid #000 !important;
        }
    }

    .attendance-card {
        border: 1px solid #ccc;
        padding: 20px;
        margin-bottom: 20px;
        background: white;
        color: black;
        max-width: 800px; /* Limit width for readability on screen */
        margin-left: auto;
        margin-right: auto;
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 2px solid #000;
        margin-bottom: 10px;
        padding-bottom: 5px;
        position: relative;
    }

    .card-header-logo {
        position: absolute;
        left: 0;
        top: 0;
        height: 60px;
    }
    
    .card-header-content {
        text-align: center;
        width: 100%;
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: bold;
        text-transform: uppercase;
    }

    .card-subtitle {
        font-size: 1.2rem;
        font-weight: bold;
    }

    .card-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-weight: bold;
        font-size: 1rem;
    }

    .card-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .card-table th, .card-table td {
        border: 1px solid #000;
        padding: 6px;
        text-align: center;
    }

    .card-table th {
        background-color: #f0f0f0;
        font-weight: bold;
    }

    .total-row {
        font-weight: bold;
        background-color: #f0f0f0;
    }

    .signature-section {
        margin-top: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        page-break-inside: avoid;
    }

    .legal-text {
        width: 50%;
        font-size: 0.65rem;
        text-align: justify;
        padding-right: 15px;
        line-height: 1.2;
    }

    .signature-wrapper {
        display: flex;
        width: 50%;
        justify-content: space-around;
        align-items: flex-end;
    }

    .signature-box {
        text-align: center;
    }

    .signature-box-line {
        border-bottom: 1px solid #000;
        margin-bottom: 5px;
        height: 35px; /* Reduced from 60px */
        width: 120px;
        margin: 0 auto;
    }

    .signature-box-square {
        border: 1px solid #000;
        margin-bottom: 5px;
        height: 55px; /* Reduced from 80px */
        width: 55px; /* Reduced from 100px */
        margin-left: auto;
        margin-right: auto;
    }

    .signature-label {
        font-size: 0.8rem;
    }
</style>

<div class="no-print">
    <MudText Typo="Typo.h5" Class="mb-4">Impresión de Checadores</MudText>

    <MudGrid>
        <MudItem xs="12" sm="3">
            <MudSelect T="string" Label="Modo de Selección" Value="DateSelectionMode" ValueChanged="OnDateSelectionModeChanged">
                <MudSelectItem Value="@("Range")">Rango de Fechas</MudSelectItem>
                <MudSelectItem Value="@("Period")">Periodo Laboral</MudSelectItem>
            </MudSelect>
        </MudItem>

        @if (DateSelectionMode == "Range")
        {
            <MudItem xs="12" sm="3">
                <MudDatePicker Label="Desde" @bind-Date="StartDate" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudDatePicker Label="Hasta" @bind-Date="EndDate" />
            </MudItem>
        }
        else
        {
            <MudItem xs="12" sm="2">
                <MudSelect T="int" Label="Año" Value="SelectedYear" ValueChanged="OnYearChanged">
                    @for (int y = DateTime.Today.Year - 1; y <= DateTime.Today.Year + 1; y++)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                 <MudSelect T="WorkPeriodMode" Label="Tipo de Periodo" Value="SelectedPeriodMode" ValueChanged="OnPeriodModeChanged">
                    <MudSelectItem Value="WorkPeriodMode.Weekly">Semanal</MudSelectItem>
                    <MudSelectItem Value="WorkPeriodMode.Fortnightly">Quincenal</MudSelectItem>
                    <MudSelectItem Value="WorkPeriodMode.Monthly">Mensual</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudSelect T="WorkPeriodDto" Label="Periodo" Value="SelectedPeriod" ValueChanged="OnPeriodChanged" ToStringFunc="@(p => p?.Name)">
                    @foreach (var period in AvailablePeriods)
                    {
                        <MudSelectItem Value="@period">@period.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        }

        <MudItem xs="12" sm="3">
            <MudSelect T="Guid?" Label="Sucursal" Value="SelectedBranchId" ValueChanged="OnBranchChanged" Clearable="true">
                <MudSelectItem T="Guid?" Value="null">Todas</MudSelectItem>
                @foreach (var branch in Branches)
                {
                    <MudSelectItem T="Guid?" Value="@branch.Id">@branch.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="3">
             <MudSelect T="string" Label="Tipo de Filtro" @bind-Value="FilterType">
                <MudSelectItem Value="@("All")">Todos</MudSelectItem>
                <MudSelectItem Value="@("Range")">Rango de Empleado</MudSelectItem>
                <MudSelectItem Value="@("Specific")">Empleado Específico</MudSelectItem>
            </MudSelect>
        </MudItem>

        @if (FilterType == "Range")
        {
            <MudItem xs="12" sm="3">
                <MudNumericField @bind-Value="StartEmployeeId" Label="ID Inicial" Min="0" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudNumericField @bind-Value="EndEmployeeId" Label="ID Final" Min="0" />
            </MudItem>
        }
        @if (FilterType == "Specific")
        {
             <MudItem xs="12" sm="6">
                <MudAutocomplete T="EmployeeDto" 
                                Label="Empleado"
                                @bind-Value="SelectedEmployeeObj" 
                                SearchFunc="@SearchEmployees"
                                ToStringFunc="@(e => e == null ? null : $"{e.Id} - {e.FullName}")"
                                ResetValueOnEmptyText="true" 
                                AdornmentColor="Color.Primary" />
            </MudItem>
        }

        <MudItem xs="12" Class="d-flex align-center justify-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadData" Class="mr-2">Generar</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="ExportPdf" StartIcon="@Icons.Material.Filled.PictureAsPdf" Disabled="@(!GroupedData.Any())" Class="mr-2">PDF</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="Print" StartIcon="@Icons.Material.Filled.Print" Disabled="@(!GroupedData.Any())">Imprimir</MudButton>
        </MudItem>
    </MudGrid>
</div>

@if (GroupedData.Any())
{
    <div class="print-container mt-4">
        @foreach (var group in GroupedData)
        {
            <div class="attendance-card page-break">
                <div class="card-header">
                    @if (_config?.CompanyLogo != null && _config.CompanyLogo.Length > 0)
                    {
                         <img src="@($"data:image/png;base64,{Convert.ToBase64String(_config.CompanyLogo)}")" class="card-header-logo" />
                    }
                    <div class="card-header-content">
                        <div class="card-title">@(_config?.CompanyName ?? "Mi Empresa")</div>
                        <div class="card-subtitle">Tarjeta de asistencia</div>
                        <div>Del @StartDate?.ToString("dd/MM/yyyy") al @EndDate?.ToString("dd/MM/yyyy")</div>
                    </div>
                </div>

                <div class="card-info">
                    <div>No. @group.Key.EmployeeId</div>
                    <div>@group.Key.EmployeeName</div>
                </div>
                
                <table class="card-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Día</th>
                            <th>Entrada</th>
                            <th>Salida</th>
                            <th>Hrs. Extra</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var day in group.Value.OrderBy(x => x.Date))
                        {
                            <tr>
                                <td>@day.Date.ToString("dd/MM/yyyy")</td>
                                <td>@day.Date.ToString("ddd")</td>
                                <td>@(day.ActualCheckIn?.ToString("HH:mm") ?? (day.MissingCheckIn ? "--" : ""))</td>
                                <td>@(day.ActualCheckOut?.ToString("HH:mm") ?? (day.MissingCheckOut ? "--" : ""))</td>
                                <td>@(FormatMinuteString(day.RoundedOvertimeMinutes))</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                         <tr class="total-row">
                            <td colspan="4" style="text-align: right;">Total Horas Extra:</td>
                            <td>@FormatMinuteString(group.Value.Sum(x => x.RoundedOvertimeMinutes))</td>
                        </tr>
                    </tfoot>
                </table>

                <div class="signature-section">
                    <div class="legal-text">
                        Previamente de asentar mi firma y mi huella digital en el presente documento, manifiesto que he revisado la relacion de entradas y salidas que el mismo contiene, por lo que acepto de conformidad dicha relacion de fechas y horas que se plasman en esta tarjeta, pues reflejan Fielmente los registros que hice de mis ingresos y egresos en el presente centro de trabajo.
                    </div>
                    <div class="signature-wrapper">
                        <div class="signature-box">
                            <div class="signature-box-line"></div>
                            <div class="signature-label">Firma</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-box-square"></div>
                            <div class="signature-label">Huella</div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
else if (HasSearched)
{
     <div class="no-print mt-4">
        <MudAlert Severity="Severity.Info">No se encontraron registros para los filtros seleccionados.</MudAlert>
    </div>
}

@using AttendanceSystem.Application.Features.Configuration.Queries.GetSystemConfiguration

@code {
    private string DateSelectionMode = "Range"; // "Range" or "Period"
    private int SelectedYear = DateTime.Today.Year;
    private WorkPeriodMode SelectedPeriodMode;
    private WorkPeriodDto? SelectedPeriod;
    private List<WorkPeriodDto> AvailablePeriods = new();

    private SystemConfigurationDto? _config;

    private DateTime? StartDate = DateTime.Today;
    private DateTime? EndDate = DateTime.Today;
    private Guid? SelectedBranchId;
    private EmployeeDto? SelectedEmployeeObj;
    private string FilterType = "All";
    private int? StartEmployeeId;
    private int? EndEmployeeId;
    
    // Grouped/Filtered data
    private Dictionary<(string EmployeeId, string EmployeeName), List<AttendanceReportViewDto>> GroupedData = new();
    private bool HasSearched = false;

    private List<EmployeeDto> _allEmployees = new();
    private List<BranchDto> Branches = new();
    
    // Cache for autocomplete
    private List<EmployeeDto> FilteredEmployees => SelectedBranchId.HasValue
        ? _allEmployees.Where(e => e.BranchId == SelectedBranchId.Value).ToList()
        : _allEmployees;

    protected override async Task OnInitializedAsync()
    {
        // Load System Config
        var configResult = await Mediator.Send(new GetSystemConfigurationQuery());
        if (configResult.IsSuccess)
        {
            _config = configResult.Value;
            SelectedPeriodMode = _config.WorkPeriodMode;
        }

        var empResult = await Mediator.Send(new GetAllEmployeesQuery());
        if (empResult.IsSuccess)
        {
            _allEmployees = empResult.Value.Where(e => e.Status == EmployeeStatus.Alta).ToList();
        }

        var branchResult = await Mediator.Send(new GetBranchesQuery());
        if (branchResult.IsSuccess)
        {
            Branches = branchResult.Value.ToList();
        }
    }


    private void OnDateSelectionModeChanged(string mode)
    {
        DateSelectionMode = mode;
        if (DateSelectionMode == "Period")
        {
            UpdateAvailablePeriods();
        }
    }

    private void OnPeriodModeChanged(WorkPeriodMode mode)
    {
        SelectedPeriodMode = mode;
        // In clean architecture, we should update config or just use the UI mode.
        // Assuming we just want to change the view for generating periods.
        // If we need to PERSIST it, we'd send a command, but here it just seems to trigger generation.
        // However, GetAvailablePeriods uses _config. 
        // We might need to clone _config and change mode if we want to preview other modes?
        // Or simply update _config locally.
        
        if (_config != null)
        {
            _config = _config with { WorkPeriodMode = mode };
        }
        UpdateAvailablePeriods();
    }
    
    private void OnYearChanged(int year)
    {
        SelectedYear = year;
        UpdateAvailablePeriods();
    }

    private void OnPeriodChanged(WorkPeriodDto? period)
    {
        SelectedPeriod = period;
        if (SelectedPeriod != null)
        {
             StartDate = SelectedPeriod.Start;
             EndDate = SelectedPeriod.End;
        }
        else
        {
             StartDate = null; 
             EndDate = null;
        }
    }

    private void UpdateAvailablePeriods()
    {
        if (_config == null) return;

        AvailablePeriods = _config.GetAvailablePeriods(SelectedYear);
        
        // Try to select current period
        var today = DateTime.Today;
        SelectedPeriod = AvailablePeriods.FirstOrDefault(p => today >= p.Start && today <= p.End) ?? AvailablePeriods.LastOrDefault();
        
        if (SelectedPeriod != null)
        {
             StartDate = SelectedPeriod.Start;
             EndDate = SelectedPeriod.End;
        }
    }

    private void OnBranchChanged(Guid? branchId)
    {
        SelectedBranchId = branchId;
        SelectedEmployeeObj = null; 
    }
    
    private Task<IEnumerable<EmployeeDto>> SearchEmployees(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
        {
            return Task.FromResult<IEnumerable<EmployeeDto>>(FilteredEmployees);
        }

        var result = FilteredEmployees.Where(e => 
            e.Id.Contains(value, StringComparison.InvariantCultureIgnoreCase) || 
            e.FullName.Contains(value, StringComparison.InvariantCultureIgnoreCase)
        );
        
        return Task.FromResult(result);
    }

    private async Task LoadData()
    {
        if (StartDate == null || EndDate == null) 
        {
            Snackbar.Add("Por favor seleccione un rango de fechas", Severity.Warning);
            return;
        }

        HasSearched = true;
        GroupedData.Clear();
        
        var branchId = SelectedBranchId.HasValue ? BranchId.From(SelectedBranchId.Value) : null;
        string? employeeId = null; // We fetch all (or by branch) then filter in memory for Range

        if (FilterType == "Specific")
        {
            if (SelectedEmployeeObj == null)
            {
                 Snackbar.Add("Por favor seleccione un empleado", Severity.Warning);
                 return;
            }
            employeeId = SelectedEmployeeObj.Id;
        }

        try 
        {
            var result = await Mediator.Send(new GetAttendanceReportQuery(
                StartDate.Value, 
                EndDate.Value,
                branchId,
                employeeId
            ));

            var list = result.ToList();

            // Additional Filtering for Range
            if (FilterType == "Range")
            {
                if (StartEmployeeId.HasValue && EndEmployeeId.HasValue)
                {
                    list = list.Where(x => {
                        if (long.TryParse(x.EmployeeId, out var id))
                        {
                            return id >= StartEmployeeId.Value && id <= EndEmployeeId.Value;
                        }
                        return false; 
                    }).ToList();
                }
                else
                {
                     Snackbar.Add("Por favor ingrese el rango de IDs", Severity.Warning);
                     return;
                }
            }

            // Group by Employee
             GroupedData = list.GroupBy(x => (x.EmployeeId, x.EmployeeName))
                               .OrderBy(g => 
                               {
                                   if (long.TryParse(g.Key.EmployeeId, out var id)) return id;
                                   return long.MaxValue;
                               })
                               .ThenBy(g => g.Key.EmployeeId)
                               .ToDictionary(g => g.Key, g => g.ToList());

            if (!GroupedData.Any())
            {
                Snackbar.Add("No se encontraron registros", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar datos: {ex.Message}", Severity.Error);
        }
    }

    private async Task Print()
    {
        await JS.InvokeVoidAsync("print");
    }

    private async Task ExportPdf()
    {
        if (!GroupedData.Any()) return;
        
        try
        {
            var pdfBytes = ReportService.GenerateAttendanceCardsPdf(GroupedData, StartDate!.Value, EndDate!.Value, _config?.CompanyName ?? "Mi Empresa", _config?.CompanyLogo);
            var fileName = $"Tarjetas_Asistencia_{DateTime.Now:yyyyMMdd_HHmm}.pdf";
            
            using var stream = new MemoryStream(pdfBytes);
            using var streamRef = new DotNetStreamReference(stream: stream);

            await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al exportar PDF: {ex.Message}", Severity.Error);
        }
    }

    private string FormatMinuteString(int minutes)
    {
        if (minutes == 0) return "00:00";
        var ts = TimeSpan.FromMinutes(minutes);
        return $"{(int)ts.TotalHours:00}:{ts.Minutes:00}";
    }
}

