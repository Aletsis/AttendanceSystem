@page "/attendance/advanced-reports"
@using MediatR
@using AttendanceSystem.Application.Features.Attendance.Queries.GetDailyAttendance
@using AttendanceSystem.Application.Features.Reports.Queries.GetAdvancedAttendanceReport
@using AttendanceSystem.Application.Features.Configuration.Queries.GetSystemConfiguration
@using AttendanceSystem.Domain.Aggregates.DailyAttendanceAggregate
@using AttendanceSystem.Domain.Aggregates.EmployeeAggregate
@using AttendanceSystem.Domain.Aggregates.BranchAggregate
@using AttendanceSystem.Domain.Repositories
@using AttendanceSystem.Domain.Enumerations
@using AttendanceSystem.Domain.ValueObjects
@using AttendanceSystem.Application.DTOs
@using System.Globalization
@inject IMediator Mediator
@inject IEmployeeRepository EmployeeRepository
@inject IBranchRepository BranchRepository
@inject ISnackbar Snackbar

@using AttendanceSystem.Blazor.Server.Components.Pages.ViewModels
@inject IDialogService DialogService

<MudText Typo="Typo.h5" Class="mb-4">Reportes Avanzados</MudText>

<MudGrid>
    <MudItem xs="12" sm="4">
        <MudSelect T="string" Label="Tipo de Reporte" @bind-Value="SelectedReportType" AdornmentColor="Color.Primary">
            <MudSelectItem Value="@("Faltas")">Faltas</MudSelectItem>
            <MudSelectItem Value="@("DescansoTrabajado")">Descanso Trabajado</MudSelectItem>
            <MudSelectItem Value="@("Retardos")">Retardos</MudSelectItem>
            <MudSelectItem Value="@("HorasExtra")">Horas Extra</MudSelectItem>
            <MudSelectItem Value="@("HorarioErroneo")">Horario Erróneo</MudSelectItem>
            <MudSelectItem Value="@("HorasLaboradas")">Horas Laboradas</MudSelectItem>
            <MudSelectItem Value="@("DescansoErroneo")">Descanso Erróneo (Solo por Periodo)</MudSelectItem>
        </MudSelect>
    </MudItem>

    <MudItem xs="12" sm="4">
        <MudSelect T="string" Label="Modo de Fecha" @bind-Value="DateMode" AdornmentColor="Color.Secondary">
            <MudSelectItem Value="@("Range")">Rango de Fechas</MudSelectItem>
            <MudSelectItem Value="@("Period")">Por Periodo Laboral</MudSelectItem>
        </MudSelect>
    </MudItem>

    <MudItem xs="12" sm="4">
        <MudSelect T="Guid?" Label="Sucursal" Value="SelectedBranchId" ValueChanged="OnBranchChanged" Clearable="true" AdornmentColor="Color.Primary">
            <MudSelectItem T="Guid?" Value="null">Todas</MudSelectItem>
            @foreach (var branch in Branches)
            {
                <MudSelectItem T="Guid?" Value="@branch.Id.Value">@branch.Name</MudSelectItem>
            }
        </MudSelect>
    </MudItem>

    @if (DateMode == "Range")
    {
        <MudItem xs="12" sm="3">
            <MudDatePicker Label="Desde" @bind-Date="StartDate" />
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudDatePicker Label="Hasta" @bind-Date="EndDate" />
        </MudItem>
    }
    else
    {
        <MudItem xs="12" sm="3">
            <MudNumericField Label="Año" @bind-Value="SelectedYear" Min="2000" Max="2100" Immediate="true" />
        </MudItem>
        <MudItem xs="12" sm="3">
            @if (_config != null)
            {
                @if (_config.WorkPeriodMode == WorkPeriodMode.Weekly)
                {
                    <MudNumericField Label="Periodo (Semana 1-52)" @bind-Value="SelectedPeriodNumber" Min="1" Max="53" Immediate="true" HelperText="@PeriodRangeText" />
                }
                else if (_config.WorkPeriodMode == WorkPeriodMode.Fortnightly)
                {
                    <MudNumericField Label="Periodo (Quincena 1-24)" @bind-Value="SelectedPeriodNumber" Min="1" Max="24" Immediate="true" HelperText="@PeriodRangeText" />
                }
                else if (_config.WorkPeriodMode == WorkPeriodMode.Monthly)
                {
                    <MudNumericField Label="Periodo (Mes 1-12)" @bind-Value="SelectedPeriodNumber" Min="1" Max="12" Immediate="true" HelperText="@PeriodRangeText" />
                }
            }
        </MudItem>
    }

    <MudItem xs="12" sm="6">
        <MudAutocomplete T="Employee" 
                        Label="Empleado (Opcional)"
                        @bind-Value="SelectedEmployeeObj" 
                        SearchFunc="@SearchEmployees"
                        ToStringFunc="@(e => e == null ? null : $"{e.Id.Value} - {e.GetFullName()}")"
                        Clearable="true"
                        AdornmentColor="Color.Primary"
                        ResetValueOnEmptyText="true" />
    </MudItem>

    <MudItem xs="12" Class="d-flex justify-end">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport">Generar Reporte</MudButton>
    </MudItem>
</MudGrid>

<MudTable Items="@DisplayedSummaries" Hover="true" Striped="true" Class="mt-4">
    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>Empleado</MudTh>
        <MudTh>Departamento</MudTh>
        <MudTh>Total</MudTh>
        <MudTh>Detalle Global</MudTh>
        <MudTh>Acciones</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.EmployeeId</MudTd>
        <MudTd>@context.EmployeeName</MudTd>
        <MudTd>@context.DepartmentName</MudTd>
        <MudTd>@context.Count</MudTd>
        <MudTd>@context.FormattedTotal</MudTd>
        <MudTd>
            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Info" OnClick="@(() => OpenDetails(context))">Ver Detalles</MudButton>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    private string SelectedReportType = "Faltas";
    private string DateMode = "Range";
    private DateTime? StartDate = DateTime.Today; 
    private DateTime? EndDate = DateTime.Today;
    private Guid? SelectedBranchId;
    private Employee? SelectedEmployeeObj;
    
    // Kept for Dropdowns - ideally replace with Query
    private List<Employee> _allEmployees = new();
    private List<Branch> Branches = new();
    
    private List<AdvancedReportSummaryDto> DisplayedSummaries = new();
    private SystemConfigurationDto _config;

    private int SelectedYear = DateTime.Today.Year;
    private int SelectedPeriodNumber = 1;

    private string PeriodRangeText 
    {
        get
        {
            if (_config == null) return string.Empty;
            try
            {
                var dates = GetPeriodDates(SelectedYear, SelectedPeriodNumber);
                return $"{dates.Start:dd/MM/yyyy} - {dates.End:dd/MM/yyyy}";
            }
            catch
            {
                return string.Empty;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _allEmployees = (await EmployeeRepository.GetAllAsync()).ToList();
        Branches = (await BranchRepository.GetAllAsync()).ToList();

        var configResult = await Mediator.Send(new GetSystemConfigurationQuery());
        if (configResult.IsSuccess)
        {
            _config = configResult.Value;
            CalculateCurrentPeriod();
        }
    }

    private void CalculateCurrentPeriod()
    {
        var now = DateTime.Today;
        SelectedYear = now.Year;

        if (_config.WorkPeriodMode == WorkPeriodMode.Weekly)
        {
            SelectedPeriodNumber = ISOWeek.GetWeekOfYear(now);
        }
        else if (_config.WorkPeriodMode == WorkPeriodMode.Monthly)
        {
            SelectedPeriodNumber = now.Month;
        }
        else // Fortnightly
        {
            var day = now.Day;
            int p = (now.Month - 1) * 2;
            if (day >= _config.FortnightSecondDay) p += 2;
            else p += 1;
            SelectedPeriodNumber = p;
        }
    }

    private (DateTime Start, DateTime End) GetPeriodDates(int year, int periodNum)
    {
        if (_config.WorkPeriodMode == WorkPeriodMode.Weekly)
        {
            try 
            {
                var s = ISOWeek.ToDateTime(year, periodNum, _config.WeeklyStartDay);
                return (s, s.AddDays(6));
            }
            catch
            {
                 var s = ISOWeek.ToDateTime(year, 1, _config.WeeklyStartDay).AddDays((periodNum - 1) * 7);
                 return (s, s.AddDays(6));
            }
        }
        else if (_config.WorkPeriodMode == WorkPeriodMode.Monthly)
        {
            if (periodNum < 1) periodNum = 1;
            if (periodNum > 12) periodNum = 12;

            var start = new DateTime(year, periodNum, 1);
            int maxDay = DateTime.DaysInMonth(year, periodNum);
            int sDay = Math.Min(_config.MonthlyStartDay, maxDay);
            
            var s = new DateTime(year, periodNum, sDay);
            var e = s.AddMonths(1).AddDays(-1);
            return (s, e);
        }
        else // Fortnightly
        {
            if (periodNum < 1) periodNum = 1;

            int monthIndex = (periodNum - 1) / 2 + 1; // 1-12
            bool isSecondHalf = (periodNum % 2 == 0);

            if (monthIndex > 12) monthIndex = 12;

            var d1 = _config.FortnightFirstDay;
            var d2 = _config.FortnightSecondDay; 

            if (!isSecondHalf) // First Half 
            {
                int maxDay = DateTime.DaysInMonth(year, monthIndex);
                int startDay = Math.Min(d1, maxDay);
                var s = new DateTime(year, monthIndex, startDay);
            
                var nextPStart = new DateTime(year, monthIndex, Math.Min(d2, maxDay));
                
                return (s, nextPStart.AddDays(-1));
            }
            else // Second Half 
            {
                int maxDay = DateTime.DaysInMonth(year, monthIndex);
                int startDay = Math.Min(d2, maxDay);
                var s = new DateTime(year, monthIndex, startDay);
                
                var nextMonth = new DateTime(year, monthIndex, 1).AddMonths(1);
                var nextStart = new DateTime(nextMonth.Year, nextMonth.Month, Math.Min(d1, DateTime.DaysInMonth(nextMonth.Year, nextMonth.Month)));
                
                return (s, nextStart.AddDays(-1));
            }
        }
    }

    private void OnBranchChanged(Guid? branchId)
    {
        SelectedBranchId = branchId;
        SelectedEmployeeObj = null; 
    }

    private Task<IEnumerable<Employee>> SearchEmployees(string value, CancellationToken token)
    {
        var filtered = SelectedBranchId.HasValue 
            ? _allEmployees.Where(e => e.BranchId.Value == SelectedBranchId.Value) 
            : _allEmployees;

        if (string.IsNullOrEmpty(value)) return Task.FromResult(filtered);

        return Task.FromResult(filtered.Where(e => 
            e.Id.Value.Contains(value, StringComparison.InvariantCultureIgnoreCase) || 
            e.GetFullName().Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private async Task LoadReport()
    {
        DateTime start, end;
        if (DateMode == "Range")
        {
            if (StartDate == null || EndDate == null) return;
            start = StartDate.Value;
            end = EndDate.Value;
        }
        else
        {
            var dates = GetPeriodDates(SelectedYear, SelectedPeriodNumber);
            start = dates.Start;
            end = dates.End;
        }

        var branchId = SelectedBranchId.HasValue ? BranchId.From(SelectedBranchId.Value) : null;
        var employeeId = SelectedEmployeeObj?.Id;

        // Use Application Query
        var result = await Mediator.Send(new GetAdvancedAttendanceReportQuery(start, end, SelectedReportType, branchId, employeeId));
        DisplayedSummaries = result.ToList();
    }

    private void OpenDetails(AdvancedReportSummaryDto item)
    {
        var parameters = new DialogParameters();
        parameters.Add("Records", item.Details);
        parameters.Add("ReportType", SelectedReportType);

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<ReportDetailsDialog>($"Detalles - {item.EmployeeName}", parameters, options);
    }
}
