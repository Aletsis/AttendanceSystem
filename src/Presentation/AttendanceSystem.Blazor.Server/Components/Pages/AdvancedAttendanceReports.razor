@page "/attendance/advanced-reports"
@using MediatR
@using AttendanceSystem.Application.Features.Attendance.Queries.GetDailyAttendance
@using AttendanceSystem.Application.Features.Reports.Queries.GetAdvancedAttendanceReport
@using AttendanceSystem.Application.Features.Configuration.Queries.GetSystemConfiguration
@using AttendanceSystem.Application.Features.Employees
@using AttendanceSystem.Application.Features.Employees.Queries
@using AttendanceSystem.Application.Features.Branches.Queries.GetBranches
@using AttendanceSystem.Domain.Enumerations
@using AttendanceSystem.Domain.ValueObjects
@using AttendanceSystem.Application.DTOs
@using AttendanceSystem.Application.Common
@using AttendanceSystem.Application.Features.Departments.Queries.GetDepartments
@using System.Globalization
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject IReportExportService ExportService
@inject IDialogService DialogService

<MudText Typo="Typo.h5" Class="mb-4">Reportes Avanzados</MudText>

@* Removed previous filter section *@

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" ActivePanelIndexChanged="OnTabChanged" Class="mt-4" Color="Color.Primary">
    <MudTabPanel Text="Faltas">
        <MudGrid Class="pa-4">
            @FilterDateSection(allowSpecific: true)
            @FilterBranchSection()
            @FilterDepartmentSection()
            @if(DateMode == "Range" || DateMode == "Period") { @FilterEmployeeSection() }
            @GenerateButtonSection()
        </MudGrid>
    </MudTabPanel>
    <MudTabPanel Text="Descanso Trabajado">
        <MudGrid Class="pa-4">
            @FilterDateSection(allowSpecific: true)
            @FilterBranchSection()
            @FilterDepartmentSection()
            @GenerateButtonSection()
        </MudGrid>
    </MudTabPanel>
    <MudTabPanel Text="Retardos">
        <MudGrid Class="pa-4">
            @FilterDateSection(allowSpecific: true)
            @FilterBranchSection()
            @FilterDepartmentSection()
            @if(DateMode == "Range" || DateMode == "Period") { @FilterEmployeeSection() }
            @GenerateButtonSection()
        </MudGrid>
    </MudTabPanel>
    <MudTabPanel Text="Horas Extra">
        <MudGrid Class="pa-4">
            @FilterDateSection(allowSpecific: true)
            @FilterBranchSection()
            @FilterDepartmentSection()
            @FilterEmployeeSection()
            @GenerateButtonSection()
        </MudGrid>
    </MudTabPanel>
    <MudTabPanel Text="Horario Erróneo">
         <MudGrid Class="pa-4">
            @FilterDateSection(allowSpecific: true)
            @FilterBranchSection()
            @FilterDepartmentSection()
            @GenerateButtonSection()
        </MudGrid>
    </MudTabPanel>
    <MudTabPanel Text="Descanso Erróneo" ToolTip="Solo válido por Periodo Laboral">
         <MudGrid Class="pa-4">
            @FilterDateSection(forcePeriod: true)
            @FilterBranchSection()
            @FilterDepartmentSection()
            @GenerateButtonSection()
        </MudGrid>
    </MudTabPanel>
</MudTabs>

<MudTable Items="@DisplayedSummaries" Hover="true" Striped="true" Class="mt-4">
    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>Empleado</MudTh>
        <MudTh>Departamento</MudTh>
        <MudTh>Total</MudTh>
        <MudTh>Detalle Global</MudTh>
        <MudTh>Acciones</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.EmployeeId</MudTd>
        <MudTd>@context.EmployeeName</MudTd>
        <MudTd>@context.DepartmentName</MudTd>
        <MudTd>@context.Count</MudTd>
        <MudTd>@context.FormattedTotal</MudTd>
        <MudTd>
            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Info" OnClick="@(() => OpenDetails(context))">Ver Detalles</MudButton>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    // Shared State
    private string SelectedReportType = "Faltas";
    private string DateMode = "Range"; 
    private DateTime? StartDate = DateTime.Today; 
    private DateTime? EndDate = DateTime.Today;
    private DateTime? SpecificDate = DateTime.Today;
    private Guid? SelectedBranchId;
    private Guid? SelectedDepartmentId;
    private EmployeeDto? SelectedEmployeeObj;
    
    private List<EmployeeDto> _allEmployees = new();
    private List<BranchDto> Branches = new();
    private List<DepartmentDto> Departments = new();
    
    private List<AdvancedReportSummaryDto> DisplayedSummaries = new();
    private SystemConfigurationDto _config;

    private int SelectedYear = DateTime.Today.Year;
    private int SelectedPeriodNumber = 1;

    private string PeriodRangeText 
    {
        get
        {
            if (_config == null) return string.Empty;
            try
            {
                var dates = _config.GetPeriodDates(SelectedYear, SelectedPeriodNumber);
                return $"{dates.Start:dd/MM/yyyy} - {dates.End:dd/MM/yyyy}";
            }
            catch
            {
                return string.Empty;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var empResult = await Mediator.Send(new GetAllEmployeesQuery());
        if (empResult.IsSuccess)
            _allEmployees = empResult.Value.Where(e => e.Status == EmployeeStatus.Alta).ToList();

        var branchResult = await Mediator.Send(new GetBranchesQuery());
        if (branchResult.IsSuccess)
            Branches = branchResult.Value.ToList();

        var deptResult = await Mediator.Send(new GetDepartmentsQuery());
        if (deptResult.IsSuccess)
            Departments = deptResult.Value.ToList();

        var configResult = await Mediator.Send(new GetSystemConfigurationQuery());
        if (configResult.IsSuccess)
        {
            _config = configResult.Value;
            CalculateCurrentPeriod();
        }
    }

    private void CalculateCurrentPeriod()
    {
        var now = DateTime.Today;
        SelectedYear = now.Year;

        if (_config.WorkPeriodMode == WorkPeriodMode.Weekly)
        {
            SelectedPeriodNumber = ISOWeek.GetWeekOfYear(now);
        }
        else if (_config.WorkPeriodMode == WorkPeriodMode.Monthly)
        {
            SelectedPeriodNumber = now.Month;
        }
        else // Fortnightly
        {
            var day = now.Day;
            int p = (now.Month - 1) * 2;
            if (day >= _config.FortnightSecondDay) p += 2;
            else p += 1;
            SelectedPeriodNumber = p;
        }
    }

    private void OnBranchChanged(Guid? branchId)
    {
        SelectedBranchId = branchId;
        SelectedEmployeeObj = null; 
    }

    private Task<IEnumerable<EmployeeDto>> SearchEmployees(string value, CancellationToken token)
    {
        var filtered = _allEmployees.AsEnumerable();

        if (SelectedBranchId.HasValue)
            filtered = filtered.Where(e => e.BranchId == SelectedBranchId.Value);

        if (SelectedDepartmentId.HasValue)
             filtered = filtered.Where(e => e.DepartmentId == SelectedDepartmentId.Value);

        if (string.IsNullOrEmpty(value)) return Task.FromResult(filtered);

        return Task.FromResult(filtered.Where(e => 
            e.Id.Contains(value, StringComparison.InvariantCultureIgnoreCase) || 
            e.FullName.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private async Task LoadReport()
    {
        DateTime start, end;
        if (DateMode == "Specific")
        {
             if (SpecificDate == null) return;
             start = SpecificDate.Value;
             end = SpecificDate.Value;
        }
        else if (DateMode == "Range")
        {
            if (StartDate == null || EndDate == null) return;
            start = StartDate.Value;
            end = EndDate.Value;
        }
        else
        {
            var dates = _config.GetPeriodDates(SelectedYear, SelectedPeriodNumber);
            start = dates.Start;
            end = dates.End;
        }

        var branchId = SelectedBranchId.HasValue ? BranchId.From(SelectedBranchId.Value) : null;
        var employeeId = SelectedEmployeeObj != null ? EmployeeId.From(SelectedEmployeeObj.Id) : null;
        var deptId = SelectedDepartmentId.HasValue ? DepartmentId.From(SelectedDepartmentId.Value) : null;

        var result = await Mediator.Send(new GetAdvancedAttendanceReportQuery(start, end, SelectedReportType, branchId, employeeId, deptId));
        DisplayedSummaries = result.ToList();
    }

    private async Task DownloadAbsenceReport()
    {
        DateTime start, end;
        if (DateMode == "Specific")
        {
             if (SpecificDate == null) 
             {
                 Snackbar.Add("Seleccione una fecha.", Severity.Warning);
                 return;
             }
             start = SpecificDate.Value;
             end = SpecificDate.Value;
        }
        else if (DateMode == "Range")
        {
            if (StartDate == null || EndDate == null) 
            {
                Snackbar.Add("Seleccione un rango de fechas.", Severity.Warning);
                return;
            }
            start = StartDate.Value;
            end = EndDate.Value;
        }
        else
        {
            var dates = _config.GetPeriodDates(SelectedYear, SelectedPeriodNumber);
            start = dates.Start;
            end = dates.End;
        }

        bool isDetailed = false;
        bool isSpecific = DateMode == "Specific";

        if (!isSpecific)
        {
             var result = await DialogService.ShowMessageBox(
                "Exportar Faltas", 
                "Seleccione el formato del reporte:", 
                yesText: "Detallado (Diario)", 
                noText: "Resumido (Totales)", 
                cancelText: "Cancelar");
             
             if (result == null) return; // Cancelled
             isDetailed = result.Value; 
        }

        // Fetch data
        var branchId = SelectedBranchId.HasValue ? BranchId.From(SelectedBranchId.Value) : null;
        var employeeId = SelectedEmployeeObj != null ? EmployeeId.From(SelectedEmployeeObj.Id) : null;
        var deptId = SelectedDepartmentId.HasValue ? DepartmentId.From(SelectedDepartmentId.Value) : null;

        var data = await Mediator.Send(new GetAdvancedAttendanceReportQuery(start, end, SelectedReportType, branchId, employeeId, deptId));
        
        // Generate Excel
        var excelBytes = ExportService.GenerateAdvancedAbsenceExcel(data, start, end, isDetailed, isSpecific, Branches.Count > 1);
        
        // Download
        using var stream = new MemoryStream(excelBytes);
        using var streamRef = new DotNetStreamReference(stream);
        var fileName = $"Faltas_{start:yyyyMMdd}_{end:yyyyMMdd}.xlsx";
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }

    private async Task DownloadWorkedRestDayReport()
    {
        DateTime start, end;
        if (DateMode == "Specific")
        {
             if (SpecificDate == null) 
             {
                 Snackbar.Add("Seleccione una fecha.", Severity.Warning);
                 return;
             }
             start = SpecificDate.Value;
             end = SpecificDate.Value;
        }
        else if (DateMode == "Range")
        {
            if (StartDate == null || EndDate == null) 
            {
                Snackbar.Add("Seleccione un rango de fechas.", Severity.Warning);
                return;
            }
            start = StartDate.Value;
            end = EndDate.Value;
        }
        else
        {
            var dates = _config.GetPeriodDates(SelectedYear, SelectedPeriodNumber);
            start = dates.Start;
            end = dates.End;
        }

        bool isDetailed = false;
        bool isSpecific = DateMode == "Specific";

        // For Specific Date, we always do the "Summary" (Flat) format effectively in Excel, 
        // but let's follow the standard pattern.
        // User asked: "si es resumido... si es detallado...". This implies choice for Range/Period.

        if (!isSpecific)
        {
             var result = await DialogService.ShowMessageBox(
                "Exportar Descanso Trabajado", 
                "Seleccione el formato del reporte:", 
                yesText: "Detallado (Diario)", 
                noText: "Resumido (Reporte)", 
                cancelText: "Cancelar");
             
             if (result == null) return; // Cancelled
             isDetailed = result.Value; 
        }

        // Fetch data
        var branchId = SelectedBranchId.HasValue ? BranchId.From(SelectedBranchId.Value) : null;
        var employeeId = SelectedEmployeeObj != null ? EmployeeId.From(SelectedEmployeeObj.Id) : null;
        var deptId = SelectedDepartmentId.HasValue ? DepartmentId.From(SelectedDepartmentId.Value) : null;

        var data = await Mediator.Send(new GetAdvancedAttendanceReportQuery(start, end, SelectedReportType, branchId, employeeId, deptId));
        
        // Generate Excel
        var excelBytes = ExportService.GenerateWorkedRestDayExcel(data, start, end, isDetailed, Branches.Count > 1);
        
        // Download
        using var stream = new MemoryStream(excelBytes);
        using var streamRef = new DotNetStreamReference(stream);
        var fileName = $"DescansoTrabajado_{start:yyyyMMdd}_{end:yyyyMMdd}.xlsx";
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }

    private async Task DownloadLateArrivalReport()
    {
        DateTime start, end;
        if (DateMode == "Specific")
        {
             if (SpecificDate == null) 
             {
                 Snackbar.Add("Seleccione una fecha.", Severity.Warning);
                 return;
             }
             start = SpecificDate.Value;
             end = SpecificDate.Value;
        }
        else if (DateMode == "Range")
        {
            if (StartDate == null || EndDate == null) 
            {
                Snackbar.Add("Seleccione un rango de fechas.", Severity.Warning);
                return;
            }
            start = StartDate.Value;
            end = EndDate.Value;
        }
        else
        {
            var dates = _config.GetPeriodDates(SelectedYear, SelectedPeriodNumber);
            start = dates.Start;
            end = dates.End;
        }

        bool isDetailed = false;
        bool isSpecific = DateMode == "Specific";

        if (!isSpecific)
        {
             var result = await DialogService.ShowMessageBox(
                "Exportar Retardos", 
                "Seleccione el formato del reporte:", 
                yesText: "Detallado (Diario)", 
                noText: "Resumido (Totales)", 
                cancelText: "Cancelar");
             
             if (result == null) return; // Cancelled
             isDetailed = result.Value; 
        }

        // Fetch data
        var branchId = SelectedBranchId.HasValue ? BranchId.From(SelectedBranchId.Value) : null;
        var employeeId = SelectedEmployeeObj != null ? EmployeeId.From(SelectedEmployeeObj.Id) : null;
        var deptId = SelectedDepartmentId.HasValue ? DepartmentId.From(SelectedDepartmentId.Value) : null;

        var data = await Mediator.Send(new GetAdvancedAttendanceReportQuery(start, end, SelectedReportType, branchId, employeeId, deptId));
        
        // Generate Excel
        var excelBytes = ExportService.GenerateLateArrivalExcel(data, start, end, isDetailed, isSpecific, Branches.Count > 1);
        
        // Download
        using var stream = new MemoryStream(excelBytes);
        using var streamRef = new DotNetStreamReference(stream);
        var fileName = $"Retardos_{start:yyyyMMdd}_{end:yyyyMMdd}.xlsx";
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }

    private async Task DownloadOvertimeReport()
    {
         DateTime start, end;
        if (DateMode == "Specific")
        {
             if (SpecificDate == null) 
             {
                 Snackbar.Add("Seleccione una fecha.", Severity.Warning);
                 return;
             }
             start = SpecificDate.Value;
             end = SpecificDate.Value;
        }
        else if (DateMode == "Range")
        {
            if (StartDate == null || EndDate == null) 
            {
                Snackbar.Add("Seleccione un rango de fechas.", Severity.Warning);
                return;
            }
            start = StartDate.Value;
            end = EndDate.Value;
        }
        else
        {
            var dates = _config.GetPeriodDates(SelectedYear, SelectedPeriodNumber);
            start = dates.Start;
            end = dates.End;
        }

        bool isDetailed = false;
        bool isSpecific = DateMode == "Specific";

        if (!isSpecific)
        {
             var result = await DialogService.ShowMessageBox(
                "Exportar Horas Extra", 
                "Seleccione el formato del reporte:", 
                yesText: "Detallado (Diario)", 
                noText: "Resumido (Totales)", 
                cancelText: "Cancelar");
             
             if (result == null) return; // Cancelled
             isDetailed = result.Value; 
        }

        // Fetch data
        var branchId = SelectedBranchId.HasValue ? BranchId.From(SelectedBranchId.Value) : null;
        var employeeId = SelectedEmployeeObj != null ? EmployeeId.From(SelectedEmployeeObj.Id) : null;
        var deptId = SelectedDepartmentId.HasValue ? DepartmentId.From(SelectedDepartmentId.Value) : null;

        var data = await Mediator.Send(new GetAdvancedAttendanceReportQuery(start, end, SelectedReportType, branchId, employeeId, deptId));
        
        // Generate Excel
        var excelBytes = ExportService.GenerateOvertimeExcel(data, start, end, isDetailed, isSpecific, Branches.Count > 1);
        
        // Download
        using var stream = new MemoryStream(excelBytes);
        using var streamRef = new DotNetStreamReference(stream);
        var fileName = $"HorasExtra_{start:yyyyMMdd}_{end:yyyyMMdd}.xlsx";
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }

    private async Task OnTabChanged(int index)
    {
        SelectedReportType = index switch
        {
            0 => "Faltas",
            1 => "DescansoTrabajado",
            2 => "Retardos",
            3 => "HorasExtra",
            4 => "HorarioErroneo",
            5 => "DescansoErroneo",
            _ => "Faltas"
        };
        
        // Reset or adjust default date mode if needed per type
        if (SelectedReportType == "DescansoErroneo")
        {
            DateMode = "Period";
        }

        // We do typically NOT reload report automatically when switching tabs if filters change
        // But user asked for filters inside tab. It's safer to clear results or wait for user to click Generate.
        DisplayedSummaries.Clear();
    }

    private void OpenDetails(AdvancedReportSummaryDto item)
    {
        var parameters = new DialogParameters();
        parameters.Add("Records", item.Details);
        parameters.Add("ReportType", SelectedReportType);

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<ReportDetailsDialog>($"Detalles - {item.EmployeeName}", parameters, options);
    }
    
    // UI FRAGMENT HELPERS
    
    private RenderFragment FilterDateSection(bool allowRange = true, bool allowPeriod = true, bool allowSpecific = false, bool forcePeriod = false) => __builder =>
    {
        if (forcePeriod)
        {
             // Force period mode UI
             DateMode = "Period"; 
             <MudItem xs="12" sm="3">
                 <MudText>Modo: Por Periodo (Requerido)</MudText>
            </MudItem>
        }
        else
        {
            <MudItem xs="12" sm="4">
                <MudSelect T="string" Label="Modo de Fecha" @bind-Value="DateMode" AdornmentColor="Color.Secondary">
                    @if(allowRange) { <MudSelectItem Value="@("Range")">Rango de Fechas</MudSelectItem> }
                    @if(allowPeriod) {  <MudSelectItem Value="@("Period")">Por Periodo Laboral</MudSelectItem> }
                    @if(allowSpecific) { <MudSelectItem Value="@("Specific")">Fecha Específica</MudSelectItem> }
                </MudSelect>
            </MudItem>
        }

        if (DateMode == "Range")
        {
            <MudItem xs="12" sm="4">
                <MudDatePicker Label="Desde" @bind-Date="StartDate" />
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudDatePicker Label="Hasta" @bind-Date="EndDate" />
            </MudItem>
        }
        else if (DateMode == "Specific")
        {
             <MudItem xs="12" sm="4">
                <MudDatePicker Label="Fecha" @bind-Date="SpecificDate" />
            </MudItem>
        }
        else
        {
            <MudItem xs="12" sm="4">
                <MudNumericField Label="Año" @bind-Value="SelectedYear" Min="2000" Max="2100" Immediate="true" />
            </MudItem>
            <MudItem xs="12" sm="4">
                @if (_config != null)
                {
                    @if (_config.WorkPeriodMode == WorkPeriodMode.Weekly)
                    {
                        <MudNumericField Label="Periodo (Semana 1-52)" @bind-Value="SelectedPeriodNumber" Min="1" Max="53" Immediate="true" HelperText="@PeriodRangeText" />
                    }
                    else if (_config.WorkPeriodMode == WorkPeriodMode.Fortnightly)
                    {
                        <MudNumericField Label="Periodo (Quincena 1-24)" @bind-Value="SelectedPeriodNumber" Min="1" Max="24" Immediate="true" HelperText="@PeriodRangeText" />
                    }
                    else if (_config.WorkPeriodMode == WorkPeriodMode.Monthly)
                    {
                        <MudNumericField Label="Periodo (Mes 1-12)" @bind-Value="SelectedPeriodNumber" Min="1" Max="12" Immediate="true" HelperText="@PeriodRangeText" />
                    }
                }
            </MudItem>
        }
    };

    private RenderFragment FilterBranchSection() => __builder =>
    {
        if (Branches != null && Branches.Count > 1) 
        {
            <MudItem xs="12" sm="4">
                <MudSelect T="Guid?" Label="Sucursal" Value="SelectedBranchId" ValueChanged="OnBranchChanged" Clearable="true" AdornmentColor="Color.Primary">
                    <MudSelectItem T="Guid?" Value="null">Todas</MudSelectItem>
                    @foreach (var branch in Branches)
                    {
                        <MudSelectItem T="Guid?" Value="@branch.Id">@branch.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        }
    };

    private RenderFragment FilterDepartmentSection() => __builder =>
    {
         <MudItem xs="12" sm="4">
            <MudSelect T="Guid?" Label="Departamento" @bind-Value="SelectedDepartmentId" Clearable="true" AdornmentColor="Color.Primary">
                <MudSelectItem T="Guid?" Value="null">Todos</MudSelectItem>
                @foreach (var dept in Departments)
                {
                    <MudSelectItem T="Guid?" Value="@dept.Id">@dept.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
    };

    private RenderFragment FilterEmployeeSection() => __builder =>
    {
        <MudItem xs="12" sm="6">
            <MudAutocomplete T="EmployeeDto" 
                            Label="Empleado (Opcional)"
                            @bind-Value="SelectedEmployeeObj" 
                            SearchFunc="@SearchEmployees"
                            ToStringFunc="@(e => e == null ? null : $"{e.Id} - {e.FullName}")"
                            Clearable="true"
                            AdornmentColor="Color.Primary"
                            ResetValueOnEmptyText="true" />
        </MudItem>
    };

    private RenderFragment GenerateButtonSection() => __builder =>
    {
        <MudItem xs="12" Class="d-flex justify-end gap-2 mt-4">
            @if (SelectedReportType == "Faltas")
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Success" OnClick="DownloadAbsenceReport" StartIcon="@Icons.Material.Filled.FileDownload">Exportar Excel</MudButton>
            }
            @if (SelectedReportType == "DescansoTrabajado")
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Success" OnClick="DownloadWorkedRestDayReport" StartIcon="@Icons.Material.Filled.FileDownload">Exportar Excel</MudButton>
            }
            @if (SelectedReportType == "Retardos")
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Success" OnClick="DownloadLateArrivalReport" StartIcon="@Icons.Material.Filled.FileDownload">Exportar Excel</MudButton>
            }
            @if (SelectedReportType == "HorasExtra")
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Success" OnClick="DownloadOvertimeReport" StartIcon="@Icons.Material.Filled.FileDownload">Exportar Excel</MudButton>
            }
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport">Generar Reporte</MudButton>
        </MudItem>
    };
}

