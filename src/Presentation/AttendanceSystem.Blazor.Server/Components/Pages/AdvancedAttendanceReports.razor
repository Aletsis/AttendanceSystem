@page "/attendance/advanced-reports"
@using MediatR
@using AttendanceSystem.Application.Features.Attendance.Queries.GetDailyAttendance
@using AttendanceSystem.Application.Features.Reports.Queries.GetAdvancedAttendanceReport
@using AttendanceSystem.Application.Features.Configuration.Queries.GetSystemConfiguration
@using AttendanceSystem.Application.Features.Employees
@using AttendanceSystem.Application.Features.Employees.Queries
@using AttendanceSystem.Application.Features.Branches.Queries.GetBranches
@using AttendanceSystem.Domain.Enumerations
@using AttendanceSystem.Domain.ValueObjects
@using AttendanceSystem.Application.DTOs
@using AttendanceSystem.Application.Common
@using System.Globalization
@inject IMediator Mediator
@inject ISnackbar Snackbar

@using AttendanceSystem.Blazor.Server.Components.Pages.ViewModels
@inject IDialogService DialogService

<MudText Typo="Typo.h5" Class="mb-4">Reportes Avanzados</MudText>

<MudGrid>
    <MudItem xs="12" sm="4">
        <MudSelect T="string" Label="Tipo de Reporte" @bind-Value="SelectedReportType" AdornmentColor="Color.Primary">
            <MudSelectItem Value="@("Faltas")">Faltas</MudSelectItem>
            <MudSelectItem Value="@("DescansoTrabajado")">Descanso Trabajado</MudSelectItem>
            <MudSelectItem Value="@("Retardos")">Retardos</MudSelectItem>
            <MudSelectItem Value="@("HorasExtra")">Horas Extra</MudSelectItem>
            <MudSelectItem Value="@("HorarioErroneo")">Horario Erróneo</MudSelectItem>
            <MudSelectItem Value="@("HorasLaboradas")">Horas Laboradas</MudSelectItem>
            <MudSelectItem Value="@("DescansoErroneo")">Descanso Erróneo (Solo por Periodo)</MudSelectItem>
        </MudSelect>
    </MudItem>

    <MudItem xs="12" sm="4">
        <MudSelect T="string" Label="Modo de Fecha" @bind-Value="DateMode" AdornmentColor="Color.Secondary">
            <MudSelectItem Value="@("Range")">Rango de Fechas</MudSelectItem>
            <MudSelectItem Value="@("Period")">Por Periodo Laboral</MudSelectItem>
        </MudSelect>
    </MudItem>

    <MudItem xs="12" sm="4">
        <MudSelect T="Guid?" Label="Sucursal" Value="SelectedBranchId" ValueChanged="OnBranchChanged" Clearable="true" AdornmentColor="Color.Primary">
            <MudSelectItem T="Guid?" Value="null">Todas</MudSelectItem>
            @foreach (var branch in Branches)
            {
                <MudSelectItem T="Guid?" Value="@branch.Id">@branch.Name</MudSelectItem>
            }
        </MudSelect>
    </MudItem>

    @if (DateMode == "Range")
    {
        <MudItem xs="12" sm="3">
            <MudDatePicker Label="Desde" @bind-Date="StartDate" />
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudDatePicker Label="Hasta" @bind-Date="EndDate" />
        </MudItem>
    }
    else
    {
        <MudItem xs="12" sm="3">
            <MudNumericField Label="Año" @bind-Value="SelectedYear" Min="2000" Max="2100" Immediate="true" />
        </MudItem>
        <MudItem xs="12" sm="3">
            @if (_config != null)
            {
                @if (_config.WorkPeriodMode == WorkPeriodMode.Weekly)
                {
                    <MudNumericField Label="Periodo (Semana 1-52)" @bind-Value="SelectedPeriodNumber" Min="1" Max="53" Immediate="true" HelperText="@PeriodRangeText" />
                }
                else if (_config.WorkPeriodMode == WorkPeriodMode.Fortnightly)
                {
                    <MudNumericField Label="Periodo (Quincena 1-24)" @bind-Value="SelectedPeriodNumber" Min="1" Max="24" Immediate="true" HelperText="@PeriodRangeText" />
                }
                else if (_config.WorkPeriodMode == WorkPeriodMode.Monthly)
                {
                    <MudNumericField Label="Periodo (Mes 1-12)" @bind-Value="SelectedPeriodNumber" Min="1" Max="12" Immediate="true" HelperText="@PeriodRangeText" />
                }
            }
        </MudItem>
    }

    <MudItem xs="12" sm="6">
        <MudAutocomplete T="EmployeeDto" 
                        Label="Empleado (Opcional)"
                        @bind-Value="SelectedEmployeeObj" 
                        SearchFunc="@SearchEmployees"
                        ToStringFunc="@(e => e == null ? null : $"{e.Id} - {e.FullName}")"
                        Clearable="true"
                        AdornmentColor="Color.Primary"
                        ResetValueOnEmptyText="true" />
    </MudItem>

    <MudItem xs="12" Class="d-flex justify-end">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport">Generar Reporte</MudButton>
    </MudItem>
</MudGrid>

<MudTable Items="@DisplayedSummaries" Hover="true" Striped="true" Class="mt-4">
    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>Empleado</MudTh>
        <MudTh>Departamento</MudTh>
        <MudTh>Total</MudTh>
        <MudTh>Detalle Global</MudTh>
        <MudTh>Acciones</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.EmployeeId</MudTd>
        <MudTd>@context.EmployeeName</MudTd>
        <MudTd>@context.DepartmentName</MudTd>
        <MudTd>@context.Count</MudTd>
        <MudTd>@context.FormattedTotal</MudTd>
        <MudTd>
            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Info" OnClick="@(() => OpenDetails(context))">Ver Detalles</MudButton>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    private string SelectedReportType = "Faltas";
    private string DateMode = "Range";
    private DateTime? StartDate = DateTime.Today; 
    private DateTime? EndDate = DateTime.Today;
    private Guid? SelectedBranchId;
    private EmployeeDto? SelectedEmployeeObj;
    
    private List<EmployeeDto> _allEmployees = new();
    private List<BranchDto> Branches = new();
    
    private List<AdvancedReportSummaryDto> DisplayedSummaries = new();
    private SystemConfigurationDto _config;

    private int SelectedYear = DateTime.Today.Year;
    private int SelectedPeriodNumber = 1;

    private string PeriodRangeText 
    {
        get
        {
            if (_config == null) return string.Empty;
            try
            {
                var dates = _config.GetPeriodDates(SelectedYear, SelectedPeriodNumber);
                return $"{dates.Start:dd/MM/yyyy} - {dates.End:dd/MM/yyyy}";
            }
            catch
            {
                return string.Empty;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var empResult = await Mediator.Send(new GetAllEmployeesQuery());
        if (empResult.IsSuccess)
            _allEmployees = empResult.Value.ToList();

        var branchResult = await Mediator.Send(new GetBranchesQuery());
        if (branchResult.IsSuccess)
            Branches = branchResult.Value.ToList();

        var configResult = await Mediator.Send(new GetSystemConfigurationQuery());
        if (configResult.IsSuccess)
        {
            _config = configResult.Value;
            CalculateCurrentPeriod();
        }
    }

    private void CalculateCurrentPeriod()
    {
        var now = DateTime.Today;
        SelectedYear = now.Year;

        if (_config.WorkPeriodMode == WorkPeriodMode.Weekly)
        {
            SelectedPeriodNumber = ISOWeek.GetWeekOfYear(now);
        }
        else if (_config.WorkPeriodMode == WorkPeriodMode.Monthly)
        {
            SelectedPeriodNumber = now.Month;
        }
        else // Fortnightly
        {
            var day = now.Day;
            int p = (now.Month - 1) * 2;
            if (day >= _config.FortnightSecondDay) p += 2;
            else p += 1;
            SelectedPeriodNumber = p;
        }
    }

    private void OnBranchChanged(Guid? branchId)
    {
        SelectedBranchId = branchId;
        SelectedEmployeeObj = null; 
    }

    private Task<IEnumerable<EmployeeDto>> SearchEmployees(string value, CancellationToken token)
    {
        var filtered = SelectedBranchId.HasValue 
            ? _allEmployees.Where(e => e.BranchId == SelectedBranchId.Value) 
            : _allEmployees;

        if (string.IsNullOrEmpty(value)) return Task.FromResult(filtered);

        return Task.FromResult(filtered.Where(e => 
            e.Id.Contains(value, StringComparison.InvariantCultureIgnoreCase) || 
            e.FullName.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private async Task LoadReport()
    {
        DateTime start, end;
        if (DateMode == "Range")
        {
            if (StartDate == null || EndDate == null) return;
            start = StartDate.Value;
            end = EndDate.Value;
        }
        else
        {
            var dates = _config.GetPeriodDates(SelectedYear, SelectedPeriodNumber);
            start = dates.Start;
            end = dates.End;
        }

        var branchId = SelectedBranchId.HasValue ? BranchId.From(SelectedBranchId.Value) : null;
        var employeeId = SelectedEmployeeObj != null ? EmployeeId.From(SelectedEmployeeObj.Id) : null;

        var result = await Mediator.Send(new GetAdvancedAttendanceReportQuery(start, end, SelectedReportType, branchId, employeeId));
        DisplayedSummaries = result.ToList();
    }

    private void OpenDetails(AdvancedReportSummaryDto item)
    {
        var parameters = new DialogParameters();
        parameters.Add("Records", item.Details);
        parameters.Add("ReportType", SelectedReportType);

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<ReportDetailsDialog>($"Detalles - {item.EmployeeName}", parameters, options);
    }
}

